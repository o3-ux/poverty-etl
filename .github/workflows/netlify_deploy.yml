name: Netlify Deploy & Smoke Test

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-deploy-test:
    runs-on: ubuntu-latest
    env:
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: ''

      - name: Install deps & build
        run: |
          if [ -f package.json ]; then
            npm ci
            if [ -f package-lock.json ] || [ -f pnpm-lock.yaml ] || [ -f yarn.lock ]; then
              echo "Using project lockfile for reproducible build"
            fi
            if [ -f package.json ] && jq -re '.scripts.build?' package.json > /dev/null; then
              npm run build
            fi
          fi

      - name: Install netlify-cli
        run: npm install -g netlify-cli@17

      - name: Debug Netlify secrets presence
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          echo "AUTH_SET=$([ -n \"${NETLIFY_AUTH_TOKEN}\" ] && echo yes || echo no) AUTH_LEN=${#NETLIFY_AUTH_TOKEN:-0}"
          echo "SITE_SET=$([ -n \"${NETLIFY_SITE_ID}\" ] && echo yes || echo no) SITE_LEN=${#NETLIFY_SITE_ID:-0}"

      - name: Deploy to Netlify (prod)
        id: deploy
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          set -e
          # Determine directory to deploy: prefer dist/, then build/, else repo root
          DIR="."
          if [ -d dist ]; then
            DIR="dist"
          elif [ -d build ]; then
            DIR="build"
          fi

          # Guard: skip deploy if secrets are missing
          if [ -z "${NETLIFY_AUTH_TOKEN:-}" ] || [ -z "${NETLIFY_SITE_ID:-}" ]; then
            echo "Netlify secrets missing; skipping deploy."
            echo '{}' > deploy.json
            echo "deploy_json_path=$(pwd)/deploy.json" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Deploying $DIR to Netlify site $NETLIFY_SITE_ID"
          netlify deploy \
            --prod \
            --auth "$NETLIFY_AUTH_TOKEN" \
            --site "$NETLIFY_SITE_ID" \
            --dir "$DIR" \
            --message "GitHub Action: ${GITHUB_SHA:-unknown}" \
            --json > deploy.json
          echo "deploy_json_path=$(pwd)/deploy.json" >> $GITHUB_OUTPUT

      - name: Extract production URL
        id: url
        run: |
          PROD_URL=$(jq -r '.deploy_url' < deploy.json)
          echo "prod_url=$PROD_URL" >> $GITHUB_OUTPUT
          echo "Production URL: $PROD_URL"

      - name: Run smoke test against production URL
        run: |
          set -e
          chmod +x smoke_test.sh

          # Capture production URL from previous step
          PROD_URL="${{ steps.url.outputs.prod_url }}"

          # Guard: skip if deploy was skipped and no URL is available
          if [ -z "" ] || [ "" = "null" ]; then
            echo "No production URL available; skipping smoke test."
            exit 0
          fi

          echo "Running smoke test against "
          ./smoke_test.sh ""

      - name: Upload deploy artifact & logs
        uses: actions/upload-artifact@v4
        with:
          name: netlify-deploy-json
          path: |
            deploy.json

      - name: Notify Slack (if webhook configured)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "${SLACK_WEBHOOK_URL:-}" ]; then
            echo "No Slack webhook configured; skipping notification."
            exit 0
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"Deploy ${{ github.sha }} â€“ ${{ job.status }}"}' \
            "$SLACK_WEBHOOK_URL"
